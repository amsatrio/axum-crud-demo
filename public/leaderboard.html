<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .rank-1 {
            background-color: #ffd700 !important;
            font-weight: bold;
        }

        /* Gold */
        .rank-2 {
            background-color: #c0c0c0 !important;
        }

        /* Silver */
        .rank-3 {
            background-color: #cd7f32 !important;
        }

        /* Bronze */
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">‚Üê Back to Quiz</a>
            <span class="navbar-text text-white">Top Performers</span>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-white py-3">
                        <h3 class="mb-0 text-center">üèÜ Global Leaderboard</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 100px">Rank</th>
                                        <th>Username</th>
                                        <th class="text-center">Score</th>
                                        <th class="text-center">Accuracy</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-body">
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2">Loading Rankings...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-outline-secondary" onclick="fetchLeaderboard()">
                        üîÑ Refresh Rankings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8003';

        async function fetchLeaderboard() {
            const tableBody = document.getElementById('leaderboard-body');

            try {
                // Adjust this endpoint to match your actual "Get All Users/Scores" API
                const response = await fetch(`${BASE_URL}/quiz/results`);
                const result = await response.json();

                if (response.ok && result.data) {
                    // Sort by correct_answer descending
                    const sortedData = result.data.sort((a, b) => {
                        // 1. Sort by Score (Descending: highest first)
                        // Using Number() because your API returns strings like "10"
                        const scoreA = Number(a.correct_answer);
                        const scoreB = Number(b.correct_answer);

                        if (scoreB !== scoreA) {
                            return scoreB - scoreA;
                        }

                        // 2. Tie-breaker: Sort by updated_on (Ascending: earlier achiever first)
                        // Use (Number(a.updated_on) - Number(b.updated_on)) for earliest first
                        // Use (Number(b.updated_on) - Number(a.updated_on)) for most recent first
                        return Number(a.updated_on) - Number(b.updated_on);
                    });
                    renderTable(sortedData);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load leaderboard data.</td></tr>`;
                }
            } catch (error) {
                console.error("Leaderboard Error:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Connection error. Please try again later.</td></tr>`;
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('leaderboard-body');
            tableBody.innerHTML = '';

            data.forEach((user, index) => {
                const rank = index + 1;
                let rankClass = '';
                let medal = '';

                // Add styling for top 3
                if (rank === 1) { rankClass = 'rank-1'; medal = 'ü•á '; }
                else if (rank === 2) { rankClass = 'rank-2'; medal = 'ü•à '; }
                else if (rank === 3) { rankClass = 'rank-3'; medal = 'ü•â '; }

                const accuracy = user.total_answered > 0
                    ? Math.round((user.correct_answer / user.total_answered) * 100)
                    : 0;

                const row = `
                    <tr class="${rankClass}">
                        <td class="fw-bold text-center">${medal}${rank}</td>
                        <td>${user.username}</td>
                        <td class="text-center fw-bold">${user.correct_answer} / ${user.total_answered}</td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${accuracy}%">
                                    ${accuracy}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Load data on page start
        fetchLeaderboard();
    </script>
</body>

</html>